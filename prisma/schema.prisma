// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// User Roles Enum
enum UserRole {
  SUPERADMIN
  DONOR
  RECEIVER
}

// User Status Enum
enum UserStatus {
  PENDING
  APPROVED
  REJECTED
  BLOCKED
}

// Donation Session Status Enum
enum SessionStatus {
  PENDING
  ACTIVE
  COMPLETED
  CANCELLED
}

// User Model
model User {
  id                String            @id @default(cuid())
  email             String            @unique
  password          String
  role              UserRole
  status            UserStatus        @default(PENDING)
  
  // Profile Information
  firstName         String
  lastName          String
  phoneNumber       String?
  aadhaarNumber     String?           // Cannot be changed after approval
  address           String?
  city              String?
  state             String?
  pincode           String?
  latitude          Float?            // For location-based matching
  longitude         Float?            // For location-based matching
  
  // Timestamps
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt
  approvedAt        DateTime?
  
  // Relations
  donorSessions     DonationSession[] @relation("DonorSessions")
  receiverSessions  DonationSession[] @relation("ReceiverSessions")
  passwordResets    PasswordReset[]
  phoneChangeReqs   PhoneChangeRequest[]
  
  @@map("users")
}

// Donation Session Model
model DonationSession {
  id                String            @id @default(cuid())
  sessionId         String            @unique // Human-readable unique ID for tracking
  
  // Participants
  donorId           String
  receiverId        String
  donor             User              @relation("DonorSessions", fields: [donorId], references: [id])
  receiver          User              @relation("ReceiverSessions", fields: [receiverId], references: [id])
  
  // Session Details
  status            SessionStatus     @default(PENDING)
  foodDescription   String?
  quantity          String?
  notes             String?
  
  // Location Data
  donorLatitude     Float?
  donorLongitude    Float?
  receiverLatitude  Float?
  receiverLongitude Float?
  
  // Timestamps
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt
  startedAt         DateTime?
  completedAt       DateTime?
  cancelledAt       DateTime?
  
  @@map("donation_sessions")
}

// Password Reset Requests Model
model PasswordReset {
  id                String            @id @default(cuid())
  userId            String
  user              User              @relation(fields: [userId], references: [id])
  
  reason            String?
  isResolved        Boolean           @default(false)
  resolvedBy        String?           // SUPERADMIN who resolved it
  
  createdAt         DateTime          @default(now())
  resolvedAt        DateTime?
  
  @@map("password_resets")
}

// Phone Number Change Requests Model
model PhoneChangeRequest {
  id                String            @id @default(cuid())
  userId            String
  user              User              @relation(fields: [userId], references: [id])
  
  oldPhoneNumber    String?
  newPhoneNumber    String
  isApproved        Boolean?          // null = pending, true = approved, false = rejected
  approvedBy        String?           // SUPERADMIN who approved/rejected
  
  createdAt         DateTime          @default(now())
  processedAt       DateTime?
  
  @@map("phone_change_requests")
}

// Audit Trail for Admin Actions
model AdminAction {
  id                String            @id @default(cuid())
  adminId           String            // SUPERADMIN user ID
  targetUserId      String?           // User being acted upon
  action            String            // "APPROVE_USER", "BLOCK_USER", "ENABLE_USER", etc.
  details           String?           // Additional details about the action
  
  createdAt         DateTime          @default(now())
  
  @@map("admin_actions")
}
